<!DOCTYPE html>
<html lang="en">
  <head>
    <title>pi covid-19 tracker</title>
    <meta http-equiv="content-type">
    <meta content="text/html">
    <meta charset="UTF-8">
    <meta name="Description" content="PiCovid: Covid-19 Tracker; Author: Vladimir Mandic <mandic00@live.com>">
    <meta name="viewport" content="width=device-width, initial-scale=0.4, minimum-scale=0.1, maximum-scale=2.0, shrink-to-fit=yes, user-scalable=yes">
    <meta name="theme-color" content="#555555"/>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto'>
    <script defer type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script defer type="text/javascript" src="https://omnipotent.net/jquery.sparkline/2.1.2/jquery.sparkline.min.js"></script>
    <script defer type="text/javascript" src="https://momentjs.com/downloads/moment.min.js"></script>
    <script defer type="text/javascript" src="https://unpkg.com/sorttable@1.0.2/sorttable.js"></script>
    <style>
      ::-webkit-scrollbar { display: none; width: 0; background: transparent }
      html { font-family: Roboto; font-size: 14px }
      body { background: black; color: #ebebeb; margin-left: 8px; margin-right: 8px }
      .row { width: 100% }
      .col { background: #555555; text-align: left; margin: 8px; padding: 8px; width: 100%; box-shadow: 5px 5px #222222 }
      .jqstooltip { background: #567d66 !important; border: 0px !important; padding: 8px; width: 100px !important; height: 30px !important }
      h1 { font-size: 1.3rem; margin-left: 8px; font-weight: bold; letter-spacing: 1px; line-height: 30px }
      h2 { font-size: 1.0rem; margin: 0px; padding: 0px; font-weight: bold; letter-spacing: 1px }
      a { color: white }
      table { margin: 10px }
      th { padding-left: 8px; color: lightblue; font-weight: bold; background: grey; line-height: 2rem; }
      td { padding-left: 8px; font-size: 1rem; text-align: right; line-height: 2rem; }
      tr:nth-child(even) { background: #505050 }
    </style>
  </head>
  <body>
    <noscript>
      <h1>Pi Covid-19 Tracker</h1><br>
      <h2>Error: JavaScript is disabled</h2>
    </noscript>
    <br>
    <div class="row">
      <span id="div-title"></span>
    </div>
    <div class="row">
      <span id="div-author" style="width: 100%" class="text-right">
        <h2>Author: <a href="mailto:mandic00@live.com">V. Mandic</a>&nbsp Source: <a href="https://github.com/vladmandic/picovid">GitHub</a></h2>
      </span>
      <span id="div-status" style="width: 100%" class="text-right"></span>
    </div>
    <div class="row">
      <div class="col"><table id="table-countries"></table></div>
      <div class="col"><table id="table-states"></table></div>
    </div>
    <div class="row">
      <div class="col" id="div-map" style="min-width: 2271px; min-height: 819px; max-width: 2271px; max-height: 819px;">
        <canvas id="canvas-map"></canvas>
      </div>
    </div>
    <div class="row">
      <div class="col" id="div-notes">
        <h1>Credits:</h1><ul>
          <li><a href="https://covidtracking.com/">The COVID Tracking Project</a></li>
          <li><a href="https://www.worldometers.info/coronavirus/">Worldometer</a></li>
          <li><a href="https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">Johns Hopkins CSSE</a></li>
          <li><a href="https://floridahealthcovid19.gov/">Florida Department of Health</a></li>
        </ul>
        <h1>Notes:</h1><ul>
          <li>New cases can appear low in early morning as they are reported throughout the day</li>
          <li>Hospitalized cases is not reported regularly by all states</li>
          <li>Pending cases is reported by only few states</li>
          <li>Map infection scale is a square root function</li>
          <li>Red/green markers are just quick indicators of current state</li>
          <li>Countries trend charts show last two months of new cases</li>
          <li>Countries link to Worldometers.info per-country web page</li>
          <li>States trend charts show last one months of new cases</li>
          <li>States link to official state web page</li>        
        </ul>
      </div>
      <div class="col" id="div-news"></div>
    </div>

    <script>
      async function get(item) {
        let http = null;
        let res = null;
        try { res = await fetch(item); } catch { /**/ }
        http = res && res.ok ? await res.text() : '';
        try { http = JSON.parse(http); } catch { /**/ }
        return http;
      }

      async function proxy(item) {
        res = await fetch(`https://pidash.ddns.net/api/proxy?url=${encodeURIComponent(item)}`, { headers: { authorization: 'Basic cGlkYXNoOmdUU2R5U2RlJWN0NDIjU2FB' } });
        http = res && res.ok ? await res.text() : '';
        return http;
      }

      const color = {
        white: (str) => `<font color="white">${str}</font>`,
        black: (str) => `<font color="black">${str}</font>`,
        red: (str) => `<font color="lightcoral">${str}</font>`,
        green: (str) => `<font color="lightgreen">${str}</font>`,
        blue: (str) => `<font color="lightblue">${str}</font>`,
        yellow: (str) => `<font color="lightyellow">${str}</font>`,
        grey: (str) => `<font color="lightgray">${str}</font>`,
        greyed: (str) => `<font color="gray">${str}</font>`,
        ok: (str, bool) => (bool ? `<font color="lightgreen">${str}</font>` : `<font color="lightcoral">${str}</font>`),
      };

      function num(value) {
        if (value) return value.toLocaleString();
        return color.greyed('N/A');
      }

      function rgb(r, g, b) {
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
      }

      function int(value) {
        return value ? parseInt(value.replace(/,/g, ''), 10) : 0;
      }

      const data = { usa: {}, usaHistory: {}, world: {}, countries: {} };

      async function getJHUSeries() {
        const body = await get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv');
        const lines = body.split('\n');
        data.jhuhistory = [];
        for (const i in lines) {
          const fields = lines[i].split(',');
          const header = fields.splice(0, 4);
          let diff = [];
          for (const f in fields) {
            if (fields[f - 1]) diff.push(fields[f] - fields[f - 1]);
            else diff.push(fields[f]);
          }
          let State = '';
          let Country = '';
          switch (header[1]) {
            case '"Korea':
              State = header[0];
              Country = 'S. Korea';
              diff = diff.slice(2, diff.length);
              break;
            case 'Canada':
              State = header[0] === 'Quebec' ? '' : header[0];
              Country = header[1];
              break;
            case 'China':
              State = header[0] === 'Henan' ? '' : header[0];
              Country = header[1];
              break;
            case 'Australia':
              State = header[0] === 'Victoria' ? '' : header[0];
              Country = header[1];
              break;
            case 'United Kingdom':
              State = header[0];
              Country = 'UK';
              break;
            case 'United Arab Emirates':
              State = header[0];
              Country = 'UAE';
              break;
            default:
              State = header[0];
              Country = header[1];
          }
          data.jhuhistory.push({ State, Country, Lat: header[2], Lon: header[3], Data: diff });
        }
      }

      async function getJHULatest() {
        const base = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports';
        const date = new Date();
        let file;
        let body = null;
        file = `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}-${date.getFullYear().toString().padStart(2, '0')}`;
        res = await fetch(`${base}/${file}.csv`);
        if (res && res.ok) body = await res.text();
        if (!body) {
          date.setDate(date.getDate() - 1);
          file = `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}-${date.getFullYear().toString().padStart(2, '0')}`;
          res = await fetch(`${base}/${file}.csv`);
          if (res && res.ok) body = await res.text();
        }
        if (!body) {
          date.setDate(date.getDate() - 2);
          file = `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}-${date.getFullYear().toString().padStart(2, '0')}`;
          res = await fetch(`${base}/${file}.csv`);
          if (res && res.ok) body = await res.text();
        }
        if (!body) return;
        lines = body.split('\n');
        const header = lines[0].split(',');
        let temp = [];
        for (const i in lines) {
          const fields = lines[i].split(',');
          const obj = {};
          for (const j in fields) {
            obj[header[j]] = fields[j];
          }
          temp.push(obj);
        }
        temp = temp.filter((val) => (val.Confirmed && parseInt(val.Confirmed, 10) > 0));
        temp = temp.filter((val) => (val.Lat && parseFloat(val.Lat) !== 0.0));
        data.jhulatest = temp;
      }

      async function getUSAData() {
        const temp = await get('https://covidtracking.com/api/us');
        data.usa = temp[0];
        data.usaHistory = await get('https://covidtracking.com/api/us/daily');
        data.states = await get('https://covidtracking.com/api/states');
        data.statesInfo = await get('https://covidtracking.com/api/states/info');
        data.statesHistory = await get('https://covidtracking.com/api/states/daily');
        data.news = await get('https://covidtracking.com/api/press');
      }

      async function getFLData() {
        const temp = await get('https://services1.arcgis.com/CY1LXxl9zlJeBuRZ/arcgis/rest/services/Florida_COVID19_Cases/FeatureServer/0/query?f=json&where=1=1&returnGeometry=false&outFields=*');
        data.florida = [];
        for (const county of temp.features) {
          data.florida.push(county.attributes);
        }
      }

      async function getWMOData() {
        const html = await proxy('https://www.worldometers.info/coronavirus/');
        if (!html) return;
        const globals = $(html).find('#maincounter-wrap > div > span');
        data.world = { total: int(globals[0].innerText), deaths: int(globals[1].innerText), recovered: int(globals[2].innerText) };
        const table = $(html).find('#main_table_countries_today > tbody:nth-child(2) > tr');
        data.countries = [];
        for (const item of table) {
          const fields = $(item).find('td');
          const country = {
            name: fields[0].innerText,
            link: $(fields[0].innerHTML).attr('href'),
            totalCases: int(fields[1].innerText),
            newCases: int(fields[2].innerText),
            totalDeaths: int(fields[3].innerText),
            newDeaths: int(fields[4].innerText),
            totalRecovered: int(fields[5].innerText),
            activeCases: int(fields[6].innerText),
            criticalCases: int(fields[7].innerText),
            densityCases: parseFloat(fields[8].innerText),
            densityDeaths: parseFloat(fields[9].innerText),
          };
          data.countries.push(country);
        }
        data.countries.sort((a, b) => (a.totalCases < b.totalCases ? 1 : -1));
        data.countries.length = 56;
      }

      async function printTitle() {
        const miami = data.florida.find((a) => a.COUNTYNAME === 'MIAMI-DADE');
        document.getElementById('div-title').innerHTML = `
          <h1>${color.blue('Updated')}: ${color.green(moment(data.usa.lastModified).format('dddd MMMM DD YYYY HH:mm'))} <br>
          ${color.blue('World Data')} | 
          Positive: ${num(data.world.total)} | 
          Active: ${num(data.world.total - data.world.deaths - data.world.recovered)} | 
          Recovered: ${num(data.world.recovered)} | 
          Deaths: ${num(data.world.recovered)}
          <br>
          ${color.blue('USA Data')} | 
          Tested: ${num(data.usa.totalTestResults)} +${num(data.usaHistory[0].totalTestResultsIncrease)} | 
          Positive: ${num(data.usa.positive)} / ${(100 * data.usa.positive / data.usa.totalTestResults).toFixed(2)}% +${num(data.usaHistory[0].positiveIncrease)} | 
          Negative: ${num(data.usa.negative)} +${num(data.usaHistory[0].negativeIncrease)} | 
          Hospitalized: ${num(data.usa.hospitalized)} +${num(data.usaHistory[0].hospitalizedIncrease)} | 
          ICU: ${num(data.usaHistory[0].inIcuCurrently)} +${data.usaHistory[0].inIcuCurrently - data.usaHistory[1].inIcuCurrently} | 
          Deaths: ${num(data.usa.death)} +${num(data.usaHistory[0].deathIncrease)}
          <br>
          ${color.blue('Miami-Dade Data')} | 
          Tested: ${num(miami.PUILab_Yes)} | 
          Positive: ${num(miami.TPositive)} | 
          Pending: ${num(miami.TPending)} | 
          Hospitalized: ${num(miami.C_Hosp_Yes)} | 
          Deaths: ${num(miami.Deaths)}
          </h1>`;
      }

      async function printStatesTable() {
        const table = document.getElementById('table-states');
        let text = '<tr><th>State</th><th>Tested</th><th>(new)</th><th></th><th>Positive</th><th>(new)</th><th>Pending</th><th>Hospitalized</th><th>(new)</th><th>Deaths</th><th>(new)</th><th>Updated</th></tr>';
        for (const state of data.states) {
          const info = data.statesInfo.find((a) => state.state === a.state);
          const history = data.statesHistory.filter((a) => state.state === a.state);
          const yesterday = history[0].positive === state.positive ? history[1] : history[0];
          text += `<tr>
            <td style="text-align: left"><b>${state.state}</b>: <a href="${info.covid19Site}">${info.name}</a></td>
            <td>${num(state.totalTestResults)}</td>
            <td>${num(state.totalTestResults - yesterday.totalTestResults)}</td>
            <td>${num(state.positive)}</td>
            <td>${color.ok(num(state.positive - yesterday.positive), 100 * (state.positive - yesterday.positive) / state.positive < 10)}</td>
            <td><span class="chart-state-new-${state.state}"></span></td>
            <td>${color.ok(num(state.pending || yesterday.pending), 100 * (state.pending || yesterday.pending) / state.totalTestResults < 10)}</td>
            <td>${num(state.hospitalized)}</td>
            <td>${num(Math.abs(state.hospitalized ? state.hospitalized - yesterday.hospitalized : 0))}</td>
            <td>${num(state.death)}</td>
            <td>${num(Math.abs(state.death - yesterday.death))}</td>
            <td>${moment(state.lastUpdateEt).add(19, 'years') > moment().subtract(2, 'days') ? color.greyed(state.lastUpdateEt) : color.red(state.lastUpdateEt)}</td>
            </tr>`;
        }
        table.innerHTML = text;
        if (data.states.length) sorttable.makeSortable(table);
      }

      async function printNews() {
        const div = document.getElementById('div-news');
        let text = '<h1>In The News</h1>';
        for (const item of data.news) {
          text += `${item.publishDate} &nbsp <b>${color.blue(item.publication)}</b>: &nbsp <a href="${item.url}">${item.title}</a><br>`;
        }
        div.innerHTML = text;
      }

      async function printCountriesTable() {
        const table = document.getElementById('table-countries');
        let text = `<tr>
          <th>Country</th><th>Cases</th><th>(new)</th><th></th><th>Deaths</th><th>(new)</th><th>Recovered</th><th>Active</th><th>Critical</th><th>Cases/1M</th><th>Deaths/1M</th>
          </tr>`;
        const countries = data.countries.length ? data.countries : [];
        for (const country of countries) {
          const densityCases = country.densityCases > 2 ? country.densityCases : null;
          text += `<tr>
            <td style="text-align: left"><b><a href="https://www.worldometers.info/coronavirus/${country.link}">${country.name}</a></b></td>
            <td>${num(country.totalCases)}</td>
            <td>${color.ok(num(country.newCases), 100 * country.newCases / country.totalCases < 8)}</td>
            <td><span class="chart-country-total-${country.name.replace(/ /g, '').replace(/\./g, '')}"></span></td>
            <td>${num(country.totalDeaths)}</td>
            <td>${num(country.newDeaths)}</td>
            <td>${color.ok(num(country.totalRecovered), 100 * country.totalRecovered / country.totalCases > 35)}</td>
            <td>${color.ok(num(country.activeCases), 100 * country.activeCases / country.totalCases < 50)}</td>
            <td>${num(country.criticalCases)}</td>
            <td>${color.ok(num(densityCases), densityCases < 200)}</td>
            <td>${color.ok(country.densityDeaths.toFixed(2), country.densityDeaths < 10)}</td>
            </tr>`;
        }
        table.innerHTML = text;
        if (data.countries.length) sorttable.makeSortable(table);
      }

      async function renderUSATrend() {
        if (!data.countries.length || !data.usaHistory) return;
        const country = data.countries.find((a) => a.name === 'USA');
        data.usaHistory.reverse();
        const trend = [];
        for (const day in data.usaHistory) {
          const val = data.usaHistory[day - 1] ? data.usaHistory[day].positive - data.usaHistory[day - 1].positive : data.usaHistory[day].positive;
          trend.push(val);
        }
        $(`.chart-country-total-${country.name}`)
          .sparkline(trend, { type: 'bar', barColor: 'lightgray', zeroColor: '', tooltipFormat: `<span>${country.name}: {{value}}</span>` });
        data.usaHistory.reverse();
      }

      async function renderCountriesTrend() {
        if (!data.countries.length || !data.jhuhistory) return;
        for (const country of data.countries) {
          if (country.name !== 'USA') {
            const history = data.jhuhistory.find((a) => country.name === a.Country && a.State === '');
            let trend = history && history.Data ? history.Data : [];
            trend = trend.map((item) => (item > 10 ? item : null));
            if (trend.length > 60) trend.splice(0, trend.length - 60);
            $(`.chart-country-total-${country.name.replace(/ /g, '').replace(/\./g, '')}`)
              .sparkline(trend, { type: 'bar', barColor: 'lightgray', zeroColor: '', tooltipFormat: `<span>${country.name}: {{value}}</span>` });
          }
        }
      }

      async function renderStatesTrend() {
        if (!data.statesHistory) return;
        for (const state of data.states) {
          const trend = [];
          const history = data.statesHistory.filter((a) => state.state === a.state);
          for (const day of history.reverse()) {
            trend.push(day.positive);
          }
          if (trend.length > 30) trend.splice(0, trend.length - 30);
          $(`.chart-state-new-${state.state}`)
            .sparkline(trend, { type: 'bar', barColor: 'lightgray', zeroColor: '', tooltipFormat: `<span>${state.state}: {{value}}</span>` });
        }
      }

      async function initMap() {
        const div = document.getElementById('div-map');
        const canvas = document.getElementById('canvas-map');
        canvas.width = div.clientWidth - 16;
        canvas.height = Math.round(div.clientWidth / 4 * 3);
        canvas.style.opacity = 0.75;
        div.style.backgroundImage = 'url("world.jpg")';
      }

      async function renderMap() {
        const canvas = document.getElementById('canvas-map');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'lightcoral';
        for (const item of data.jhulatest) {
          const size = Math.round(Math.sqrt(Math.sqrt(3 * item.Confirmed)));
          const posy = (90 - parseFloat(item.Lat)) * canvas.height / 270 - 130;
          const posx = (parseFloat(item.Long_) + 180) * canvas.width / 360;
          ctx.fillStyle = rgb(250, 128 - 2 * size, 128 - size);
          ctx.beginPath();
          ctx.arc(posx, posy, size, 0, 2 * Math.PI, false);
          ctx.fill();
        }
      }

      async function status() {
        document.getElementById('div-status').innerHTML = `&nbsp <h2>Data Sources Status: 
          ${color.ok('World Latest', data.world && data.world.total > 0)} | 
          ${color.ok('Countries', data.countries && data.countries.length > 0)} | 
          ${color.ok('USA Current', data.usa && data.usa.totalTestResults > 0)} | 
          ${color.ok('USA History', data.usaHistory && data.usaHistory.length > 0)} | 
          ${color.ok('USA States', data.statesHistory && data.statesHistory.length > 0)} | 
          ${color.ok('JHU Latest', data.jhulatest && data.jhulatest.length > 0)} | 
          ${color.ok('JHU Series', data.jhuhistory && data.jhuhistory.length > 0)} | 
          ${color.ok('Florida', data.florida && data.florida.length > 0)} | 
          ${color.ok('News', data.news && data.news.length > 0)}
          </h2>`;
      }

      async function main() {
        initMap();
        const wait = {};
        wait.wmo = getWMOData();
        wait.usa = getUSAData();
        wait.fl = getFLData();
        await wait.wmo;
        await wait.usa;
        await wait.fl;
        printTitle();
        printCountriesTable();
        printStatesTable();
        renderStatesTrend();
        renderUSATrend();
        getJHUSeries().then(() => renderCountriesTrend());
        getJHULatest().then(() => renderMap());
        // printNews();
        setTimeout(main, 30 * 60 * 1000);
      }

      main();
      setInterval(status, 1000);
    </script>

  </body>
</html>
